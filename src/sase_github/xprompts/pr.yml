input:
  - name: name
    type: word

steps:
  - name: create_branch
    bash: |
      BRANCH="{{ name }}"
      git checkout -b "$BRANCH" 2>&1
      git push -u origin "$BRANCH" 2>&1
      echo "branch_name=$BRANCH"
      echo "meta_changespec=$BRANCH"
    output:
      branch_name: word

  - name: inject
    prompt_part: ""

  - name: create_changespec
    hidden: true
    python: |
      from sase_github.scripts.pr_create_changespec import main
      main(
          name={{ name | tojson }},
          prompt={{ _prompt | tojson }},
          response={{ _response | tojson }},
      )
    output:
      success: bool
      cl_name: word
      project_file: path
      default_branch: word

  - name: create_pr
    hidden: true
    if: "{{ create_changespec.success | default(false) }}"
    bash: |
      BRANCH="{{ create_branch.branch_name }}"
      DEFAULT_BRANCH="{{ create_changespec.default_branch }}"

      # Check for existing PR first
      EXISTING_URL=$(gh pr view "$BRANCH" --json url --jq '.url' 2>/dev/null || echo "")
      if [ -n "$EXISTING_URL" ]; then
        echo "pr_url=$EXISTING_URL"
        echo "success=true"
        exit 0
      fi

      # Get PR title from first commit
      PR_TITLE=$(git log --format='%s' "origin/$DEFAULT_BRANCH".."$BRANCH" 2>/dev/null | tail -1)
      if [ -z "$PR_TITLE" ]; then
        PR_TITLE="Agent changes on branch $BRANCH"
      fi

      PR_URL=$(gh pr create \
        --base "$DEFAULT_BRANCH" \
        --head "$BRANCH" \
        --title "$PR_TITLE" \
        --body "Automated PR from sase." 2>&1) || true

      if echo "$PR_URL" | grep -q "^http"; then
        echo "pr_url=$PR_URL"
        echo "success=true"
      else
        echo "pr_url="
        echo "success=false"
        echo "Error: $PR_URL" >&2
      fi
    output: { pr_url: line, success: bool }

  - name: update_cl
    hidden: true
    if: "{{ create_pr.success | default(false) }}"
    python: |
      from sase.status_state_machine import update_changespec_cl_atomic

      project_file = {{ create_changespec.project_file | tojson }}
      cl_name = {{ create_changespec.cl_name | tojson }}
      pr_url = {{ create_pr.pr_url | tojson }}

      if pr_url and pr_url.startswith("http"):
          update_changespec_cl_atomic(project_file, cl_name, pr_url)
          print("updated=true")
          print(f"pr_url={pr_url}")
      else:
          print("updated=false")
          print(f"pr_url={pr_url}")
    output: { updated: bool, pr_url: line }
