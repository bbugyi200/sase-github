wraps_all: true

input:
  - name: gh_ref
    type: word
  - name: n
    type: int
    default: null
  - name: release
    type: bool
    default: true

steps:
  - name: setup
    python: |
      from sase_github.scripts.gh_setup import main
      main(
          gh_ref={{ gh_ref | tojson }},
          n={{ n | tojson }},
          release={{ release | tojson }},
      )
    output:
      project_name: word
      project_file: path
      workspace_dir: path
      workspace_num: int
      checkout_target: word
      primary_workspace_dir: path
      should_release: bool

  - name: prepare
    bash: |
      # Stash any uncommitted changes (including untracked files)
      if ! git diff --quiet HEAD 2>/dev/null || [ -n "$(git ls-files --others --exclude-standard)" ]; then
        git stash push --include-untracked -m "gh-workflow-$(date +%s)" --quiet
        echo "stashed=true"
      else
        echo "stashed=false"
      fi
      git pull --rebase --quiet 2>&1 || true
      echo "head_before=$(git rev-parse HEAD)"
      echo "success=true"
    output: { success: bool, head_before: word, stashed: bool }

  - name: inject
    prompt_part: ""

  - name: release
    if: "{{ setup.should_release }}"
    python: |
      from sase.running_field import release_workspace

      release_workspace(
          {{ setup.project_file | tojson }},
          {{ setup.workspace_num }},
          f"gh-{{ gh_ref }}",
          {{ gh_ref | tojson }} if "/" not in {{ gh_ref | tojson }} else None,
      )
      print("released=true")
    output: { released: bool }

  - name: diff
    bash: |
      head_before="{{ prepare.head_before }}"
      if [ -z "$head_before" ]; then
        exit 0
      fi
      head_now=$(git rev-parse HEAD)
      diff_file=$(mktemp /tmp/sase-gh-XXXXXX.diff)
      if [ "$head_now" != "$head_before" ]; then
        # Commits were made — show only the last commit's diff
        git diff HEAD~1 HEAD > "$diff_file" 2>/dev/null
        commit_msg=$(git log -1 --format='%s' HEAD)
        echo "meta_commit_message=$commit_msg"
      else
        # No commits — show uncommitted changes
        git diff HEAD > "$diff_file" 2>/dev/null
        git ls-files --others --exclude-standard -z 2>/dev/null \
          | while IFS= read -r -d '' f; do
              git diff --no-index /dev/null "$f" 2>/dev/null
            done >> "$diff_file"
      fi
      if [ -s "$diff_file" ]; then
        echo "diff_path=$diff_file"
      else
        rm -f "$diff_file"
      fi
    output: { diff_path: path, meta_commit_message: line }
