input:
  - name: name
    type: word

steps:
  - name: get_context
    python: |
      from sase_github.scripts.new_pr_desc_get_context import main
      main(name={{ name | tojson }})
    output:
      error: line
      description: line
      diff_file: path
      commits: text
      workspace_dir: path
      default_branch: word
      branch_name: word

  - name: generate
    if: "{{ not get_context.error }}"
    agent: |
      Generate a PR title and body for the following changes.

      ## ChangeSpec Description
      {{ get_context.description }}

      ## Commits
      {{ get_context.commits }}

      ## Diff
      @{{ get_context.diff_file }}

      ## Instructions
      - PR title: Use conventional commit format (e.g., "feat: ...", "fix: ..."), under 72 characters
      - PR body: Start with "## Summary" followed by 1-3 bullet points

      Output EXACTLY in this format (no extra text):
      TITLE: <your title here>
      BODY:
      <your body here>

  - name: apply
    if: "{{ not get_context.error }}"
    bash: |
      # Check if PR exists for this branch
      PR_NUMBER=$(gh pr view "{{ get_context.branch_name }}" --json number --jq '.number' 2>/dev/null || echo "")
      if [ -z "$PR_NUMBER" ]; then
        echo "applied=false"
        echo "No existing PR found for branch {{ get_context.branch_name }}"
        exit 0
      fi

      # Extract title and body from response
      RESPONSE="{{ _response }}"
      TITLE=$(echo "$RESPONSE" | grep -m1 '^TITLE: ' | sed 's/^TITLE: //')
      BODY=$(echo "$RESPONSE" | sed -n '/^BODY:$/,$ p' | tail -n +2)

      if [ -n "$TITLE" ] && [ -n "$BODY" ]; then
        gh pr edit "$PR_NUMBER" --title "$TITLE" --body "$BODY" 2>/dev/null && echo "applied=true" || echo "applied=false"
      else
        echo "applied=false"
        echo "Could not parse title/body from response"
      fi
    output: { applied: bool }
